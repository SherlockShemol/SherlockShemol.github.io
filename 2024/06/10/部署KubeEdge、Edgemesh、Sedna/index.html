<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>部署KubeEdge、Edgemesh、Sedna · Shemol's Blog</title><meta name="description" content="下载keadm下载keadm用于安装KubeEdge，官方文档：https://kubeedge.io/docs/setup/install-with-keadm/（英文版里有下载的部分中文版文档却没有，就有点迷惑…）
wget https://github.com/kubeedge/kubeedg"><meta name="og:description" content="下载keadm下载keadm用于安装KubeEdge，官方文档：https://kubeedge.io/docs/setup/install-with-keadm/（英文版里有下载的部分中文版文档却没有，就有点迷惑…）
wget https://github.com/kubeedge/kubeedg"><meta name="twitter:site" content="Shemol's Blog"><meta name="twitter:title" content="部署KubeEdge、Edgemesh、Sedna"><meta name="twitter:card" content="summary"><meta name="keywords" content=""><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 7.3.0"><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div class="container" id="stage"><div class="row"><div class="col-sm-3 col-xs-12 side-container invisible" id="side-bar"><div class="vertical-text site-title"><h3 class="site-title-small" tabindex="-1"><a class="a-title" href="/">Shemol's Blog</a></h3><h1 class="site-title-large" tabindex="-1"><a class="a-title" href="/"></a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div class="site-title-links" id="site-nav"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archive</a></li><li><a href="/tags">Tags</a></li><li><a href="/friends/index.html">friends</a></li><li><a href="/about/index.html">about</a></li><li class="soc"></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2024&nbsp;<a target="_blank" href="https://shemol.tech" rel="noopener noreferrer">Shemol</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div class="col-sm-9 col-xs-12 main-container invisible" id="main-container"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>部署KubeEdge、Edgemesh、Sedna</a></p><p class="post-meta"><span class="date meta-item">Posted at&nbsp;2024-06-10</span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a class="a-tag" href="/tags/KubeEdge/" title="KubeEdge">KubeEdge</a><span>&nbsp;</span><a class="a-tag" href="/tags/流程记录/" title="流程记录">流程记录</a><span>&nbsp;</span></span></p><p class="post-abstract"><span id="more"></span>
<h1 id="下载keadm"><a href="#下载keadm" class="headerlink" title="下载keadm"></a>下载keadm</h1><p>下载<code>keadm</code>用于安装KubeEdge，官方文档：<a target="_blank" rel="noopener" href="https://kubeedge.io/docs/setup/install-with-keadm/">https://kubeedge.io/docs/setup/install-with-keadm/</a><br>（英文版里有下载的部分中文版文档却没有，就有点迷惑…）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash">wget https://github.com/kubeedge/kubeedge/releases/download/v1.16.2/keadm-v1.16.2-linux-amd64.tar.gz<br><br>tar -zxvf keadm-v1.16.2-linux-amd64.tar.gz<br><span class="hljs-built_in"><code class="language-hljs bash">wget https://github.com/kubeedge/kubeedge/releases/download/v1.16.2/keadm-v1.16.2-linux-amd64.tar.gz<br><br>tar -zxvf keadm-v1.16.2-linux-amd64.tar.gz<br><span class="hljs-built_in">cp</span> keadm-1.16.2-linux-amd64/keadm/keadm /usr/local/bin/keadm   <br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>

<h1 id="设置云端（KubeEdge主节点）"><a href="#设置云端（KubeEdge主节点）" class="headerlink" title="设置云端（KubeEdge主节点）"></a>设置云端（KubeEdge主节点）</h1><figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><span class="hljs-built_in">sudo</span> keadm init --advertise-address=主机ip地址 --kubeedge-version=v1.16.2 --<span class="hljs-built_in">set</span> iptablesManager.mode=<span class="hljs-string">&quot;external&quot;</span> --<span class="hljs-built_in">set</span> cloudCore.modules.dynamicController.<span class="hljs-built_in">enable</span>=<span class="hljs-literal"><code class="language-hljs bash"><span class="hljs-built_in">sudo</span> keadm init --advertise-address=主机ip地址 --kubeedge-version=v1.16.2 --<span class="hljs-built_in">set</span> iptablesManager.mode=<span class="hljs-string">&quot;external&quot;</span> --<span class="hljs-built_in">set</span> cloudCore.modules.dynamicController.<span class="hljs-built_in">enable</span>=<span class="hljs-literal">true</span> <br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>还有一个配置项其实是<code>--kube-config=/root/.kube/config</code>，但默认就是这个我就删掉了，如果<code>config</code>文件不在默认路径需要设置一下，具体也可以<code>keadm --help</code>查看一下。<br>如果没有成功，可能有很多很多原因啦（心酸）。<br>一个原因可能是没有移除node上的污点，导致node上无法部署业务服务，解决方法：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><code class="language-hljs bash">kubectl taint nodes master node-role.kubernetes.io/control-plane:NoSchedule-<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>还有一个原因可能是cloudcore镜像没pull下来，这个时候可以再检查一下给containerd配置的代理是否生效，或者用国内镜像来代替，我当时用的是<a target="_blank" rel="noopener" href="https://docker.aityp.com/">渡渡鸟镜像同步站</a>，搜索的话能看到我当时用的cloudcore v1.16.2版本。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><code class="language-hljs bash">kubectl edit pod/daemonset/deployment ** -n **<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>然后替换为国内镜像的地址就好了。<br>我还遇到过<code>disk pressure</code>的问题…但是这个应该比较少见。<br>总之遇到问题积极<code>describe pod/node</code>查看日志信息就好啦。</p>
<p>当cloudcore正常运行后，我们就要<code>keadm gettoken --kube-config=...</code>查看<code>token</code>，准备部署edgecore。</p>
<h1 id="设置边端（KubeEdge工作节点）"><a href="#设置边端（KubeEdge工作节点）" class="headerlink" title="设置边端（KubeEdge工作节点）"></a>设置边端（KubeEdge工作节点）</h1><p>在边端设备上（已经装好containerd和keadm）：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><span class="hljs-built_in">sudo</span> keadm <span class="hljs-built_in">join</span>  --kubeedge-version=1.16.2 --cloudcore-ipport=<span class="hljs-string"><code class="language-hljs bash"><span class="hljs-built_in">sudo</span> keadm <span class="hljs-built_in">join</span>  --kubeedge-version=1.16.2 --cloudcore-ipport=<span class="hljs-string">"云端ip地址"</span>:10000  --remote-runtime-endpoint=unix:///run/containerd/containerd.sock --cgroupdriver=systemd --token=**<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>感觉前面如果都做好了一般没有问题，如果出现问题，记得查看日志，还要多搜搜Github上的issue。</p>
<h1 id="部署EdgeMesh"><a href="#部署EdgeMesh" class="headerlink" title="部署EdgeMesh"></a>部署EdgeMesh</h1><p>这是我犯错最多的地方，也是花费时间最多的地方，如果没有部署好的话，后面联合推理实例是根本跑不起来的。<br>官方文档：<a target="_blank" rel="noopener" href="https://edgemesh.netlify.app/guide/">https://edgemesh.netlify.app/guide/</a></p>
<h2 id="开启边缘Kube-API端点功能"><a href="#开启边缘Kube-API端点功能" class="headerlink" title="开启边缘Kube-API端点功能"></a>开启边缘Kube-API端点功能</h2><ul>
<li>1.云端开启dynamicController模块<br>如果是用上面的命令部署的cloudcore，这里是已经开启的，因为我加了<code>--set cloudCore.modules.dynamicController.enable=true</code>。</li>
<li>2.边缘端打开metaServer 模块，注意配置完成后，要<strong>重启edgecore</strong>。<figure class="highlight yaml"><table><tr><td class="code"><pre class="line-numbers language-hljs yaml"><span class="hljs-string">vim</span> <span class="hljs-string">/etc/kubeedge/config/edgecore.yaml</span><br><span class="hljs-attr">modules:</span><br>  <span class="hljs-string">...</span><br>  <span class="hljs-attr">edgeMesh:</span><br>    <span class="hljs-attr">enable:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-string">...</span><br>  <span class="hljs-attr">metaManager:</span><br>    <span class="hljs-attr">metaServer:</span><br>      <span class="hljs-attr">enable:</span> <span class="hljs-literal"><code class="language-hljs yaml"><span class="hljs-string">vim</span> <span class="hljs-string">/etc/kubeedge/config/edgecore.yaml</span><br><span class="hljs-attr">modules:</span><br>  <span class="hljs-string">...</span><br>  <span class="hljs-attr">edgeMesh:</span><br>    <span class="hljs-attr">enable:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-string">...</span><br>  <span class="hljs-attr">metaManager:</span><br>    <span class="hljs-attr">metaServer:</span><br>      <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
重启edgecore<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><code class="language-hljs bash">systemctl restart edgecore<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure></li>
<li>3.在边缘节点，配置clusterDNS和clusterDomain，配置完成后，<strong>需要重启edgecore</strong>。<figure class="highlight plaintext"><table><tr><td class="code"><pre class="line-numbers language-hljs plaintext"><code class="language-hljs plaintext">$ vim /etc/kubeedge/config/edgecore.yaml<br>modules:<br>  ...<br>  edged:<br>    ...<br>    tailoredKubeletConfig:<br>      ...<br>      clusterDNS:<br>      - 169.254.96.16<br>      clusterDomain: cluster.local<br>...<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
一定要注意配置的位置（都是泪啊）…<br><code>clusterDNS</code>的值不要变。<br>如同文档里说的，clusterDNS 设置的值 ‘169.254.96.16’ 来自于 <a target="_blank" rel="noopener" href="https://edgemesh.netlify.app/zh/reference/config-items.html#edgemesh-agent-cfg">commonConfig在新窗口打开</a> 中 bridgeDeviceIP 的默认值，正常情况下无需修改，非得修改请保持两者一致。<br>重启edgecore。<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><code class="language-hljs bash">systemctl restart edgecore<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure></li>
<li>4.最后，在边缘节点，测试边缘Kube-API端点功能是否正常：<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash">$ curl 127.0.0.1:10550/api/v1/services<br>&#123;<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;v1&quot;</span>,<span class="hljs-string">&quot;items&quot;</span>:[&#123;<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;v1&quot;</span>,<span class="hljs-string">&quot;kind&quot;</span>:<span class="hljs-string">&quot;Service&quot;</span>,<span class="hljs-string">&quot;metadata&quot;</span>:&#123;<span class="hljs-string">&quot;creationTimestamp&quot;</span>:<span class="hljs-string">&quot;2021-04-14T06:30:05Z&quot;</span>,<span class="hljs-string">&quot;labels&quot;</span>:&#123;<span class="hljs-string">&quot;component&quot;</span>:<span class="hljs-string">&quot;apiserver&quot;</span>,<span class="hljs-string">&quot;provider&quot;</span>:<span class="hljs-string">&quot;kubernetes&quot;</span>&#125;,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;kubernetes&quot;</span>,<span class="hljs-string">&quot;namespace&quot;</span>:<span class="hljs-string">&quot;default&quot;</span>,<span class="hljs-string">&quot;resourceVersion&quot;</span>:<span class="hljs-string">&quot;147&quot;</span>,<span class="hljs-string">&quot;selfLink&quot;</span>:<span class="hljs-string">&quot;default/services/kubernetes&quot;</span>,<span class="hljs-string">&quot;uid&quot;</span>:<span class="hljs-string">&quot;55eeebea-08cf-4d1a-8b04-e85f8ae112a9&quot;</span>&#125;,<span class="hljs-string">&quot;spec&quot;</span>:&#123;<span class="hljs-string">&quot;clusterIP&quot;</span>:<span class="hljs-string">&quot;10.96.0.1&quot;</span>,<span class="hljs-string">&quot;ports&quot;</span>:[&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;https&quot;</span>,<span class="hljs-string">&quot;port&quot;</span>:443,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;TCP&quot;</span>,<span class="hljs-string">&quot;targetPort&quot;</span>:6443&#125;],<span class="hljs-string">&quot;sessionAffinity&quot;</span>:<span class="hljs-string">&quot;None&quot;</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;ClusterIP&quot;</span>&#125;,<span class="hljs-string">&quot;status&quot;</span>:&#123;<span class="hljs-string">&quot;loadBalancer&quot;</span>:&#123;&#125;&#125;&#125;,&#123;<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;v1&quot;</span>,<span class="hljs-string">&quot;kind&quot;</span>:<span class="hljs-string">&quot;Service&quot;</span>,<span class="hljs-string">&quot;metadata&quot;</span>:&#123;<span class="hljs-string">&quot;annotations&quot;</span>:&#123;<span class="hljs-string">&quot;prometheus.io/port&quot;</span>:<span class="hljs-string">&quot;9153&quot;</span>,<span class="hljs-string">&quot;prometheus.io/scrape&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>&#125;,<span class="hljs-string">&quot;creationTimestamp&quot;</span>:<span class="hljs-string">&quot;2021-04-14T06:30:07Z&quot;</span>,<span class="hljs-string">&quot;labels&quot;</span>:&#123;<span class="hljs-string">&quot;k8s-app&quot;</span>:<span class="hljs-string">&quot;kube-dns&quot;</span>,<span class="hljs-string">&quot;kubernetes.io/cluster-service&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>,<span class="hljs-string">&quot;kubernetes.io/name&quot;</span>:<span class="hljs-string">&quot;KubeDNS&quot;</span>&#125;,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;kube-dns&quot;</span>,<span class="hljs-string">&quot;namespace&quot;</span>:<span class="hljs-string">&quot;kube-system&quot;</span>,<span class="hljs-string">&quot;resourceVersion&quot;</span>:<span class="hljs-string">&quot;203&quot;</span>,<span class="hljs-string">&quot;selfLink&quot;</span>:<span class="hljs-string">&quot;kube-system/services/kube-dns&quot;</span>,<span class="hljs-string">&quot;uid&quot;</span>:<span class="hljs-string">&quot;c221ac20-cbfa-406b-812a-c44b9d82d6dc&quot;</span>&#125;,<span class="hljs-string">&quot;spec&quot;</span>:&#123;<span class="hljs-string">&quot;clusterIP&quot;</span>:<span class="hljs-string">&quot;10.96.0.10&quot;</span>,<span class="hljs-string">&quot;ports&quot;</span>:[&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;dns&quot;</span>,<span class="hljs-string">&quot;port&quot;</span>:53,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;UDP&quot;</span>,<span class="hljs-string">&quot;targetPort&quot;</span>:53&#125;,&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;dns-tcp&quot;</span>,<span class="hljs-string">&quot;port&quot;</span>:53,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;TCP&quot;</span>,<span class="hljs-string">&quot;targetPort&quot;</span>:53&#125;,&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;metrics&quot;</span>,<span class="hljs-string">&quot;port&quot;</span>:9153,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;TCP&quot;</span>,<span class="hljs-string">&quot;targetPort&quot;</span>:9153&#125;],<span class="hljs-string">&quot;selector&quot;</span>:&#123;<span class="hljs-string">&quot;k8s-app&quot;</span>:<span class="hljs-string">&quot;kube-dns&quot;</span>&#125;,<span class="hljs-string">&quot;sessionAffinity&quot;</span>:<span class="hljs-string">&quot;None&quot;</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;ClusterIP&quot;</span>&#125;,<span class="hljs-string">&quot;status&quot;</span>:&#123;<span class="hljs-string">&quot;loadBalancer&quot;</span>:&#123;&#125;&#125;&#125;],<span class="hljs-string">&quot;kind&quot;</span>:<span class="hljs-string">&quot;ServiceList&quot;</span>,<span class="hljs-string">&quot;metadata&quot;</span>:&#123;<span class="hljs-string">&quot;resourceVersion&quot;</span>:<span class="hljs-string">&quot;377360&quot;</span>,<span class="hljs-string">&quot;selfLink&quot;</span>:<span class="hljs-string"><code class="language-hljs bash">$ curl 127.0.0.1:10550/api/v1/services<br>&#123;<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;v1&quot;</span>,<span class="hljs-string">&quot;items&quot;</span>:[&#123;<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;v1&quot;</span>,<span class="hljs-string">&quot;kind&quot;</span>:<span class="hljs-string">&quot;Service&quot;</span>,<span class="hljs-string">&quot;metadata&quot;</span>:&#123;<span class="hljs-string">&quot;creationTimestamp&quot;</span>:<span class="hljs-string">&quot;2021-04-14T06:30:05Z&quot;</span>,<span class="hljs-string">&quot;labels&quot;</span>:&#123;<span class="hljs-string">&quot;component&quot;</span>:<span class="hljs-string">&quot;apiserver&quot;</span>,<span class="hljs-string">&quot;provider&quot;</span>:<span class="hljs-string">&quot;kubernetes&quot;</span>&#125;,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;kubernetes&quot;</span>,<span class="hljs-string">&quot;namespace&quot;</span>:<span class="hljs-string">&quot;default&quot;</span>,<span class="hljs-string">&quot;resourceVersion&quot;</span>:<span class="hljs-string">&quot;147&quot;</span>,<span class="hljs-string">&quot;selfLink&quot;</span>:<span class="hljs-string">&quot;default/services/kubernetes&quot;</span>,<span class="hljs-string">&quot;uid&quot;</span>:<span class="hljs-string">&quot;55eeebea-08cf-4d1a-8b04-e85f8ae112a9&quot;</span>&#125;,<span class="hljs-string">&quot;spec&quot;</span>:&#123;<span class="hljs-string">&quot;clusterIP&quot;</span>:<span class="hljs-string">&quot;10.96.0.1&quot;</span>,<span class="hljs-string">&quot;ports&quot;</span>:[&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;https&quot;</span>,<span class="hljs-string">&quot;port&quot;</span>:443,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;TCP&quot;</span>,<span class="hljs-string">&quot;targetPort&quot;</span>:6443&#125;],<span class="hljs-string">&quot;sessionAffinity&quot;</span>:<span class="hljs-string">&quot;None&quot;</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;ClusterIP&quot;</span>&#125;,<span class="hljs-string">&quot;status&quot;</span>:&#123;<span class="hljs-string">&quot;loadBalancer&quot;</span>:&#123;&#125;&#125;&#125;,&#123;<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;v1&quot;</span>,<span class="hljs-string">&quot;kind&quot;</span>:<span class="hljs-string">&quot;Service&quot;</span>,<span class="hljs-string">&quot;metadata&quot;</span>:&#123;<span class="hljs-string">&quot;annotations&quot;</span>:&#123;<span class="hljs-string">&quot;prometheus.io/port&quot;</span>:<span class="hljs-string">&quot;9153&quot;</span>,<span class="hljs-string">&quot;prometheus.io/scrape&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>&#125;,<span class="hljs-string">&quot;creationTimestamp&quot;</span>:<span class="hljs-string">&quot;2021-04-14T06:30:07Z&quot;</span>,<span class="hljs-string">&quot;labels&quot;</span>:&#123;<span class="hljs-string">&quot;k8s-app&quot;</span>:<span class="hljs-string">&quot;kube-dns&quot;</span>,<span class="hljs-string">&quot;kubernetes.io/cluster-service&quot;</span>:<span class="hljs-string">&quot;true&quot;</span>,<span class="hljs-string">&quot;kubernetes.io/name&quot;</span>:<span class="hljs-string">&quot;KubeDNS&quot;</span>&#125;,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;kube-dns&quot;</span>,<span class="hljs-string">&quot;namespace&quot;</span>:<span class="hljs-string">&quot;kube-system&quot;</span>,<span class="hljs-string">&quot;resourceVersion&quot;</span>:<span class="hljs-string">&quot;203&quot;</span>,<span class="hljs-string">&quot;selfLink&quot;</span>:<span class="hljs-string">&quot;kube-system/services/kube-dns&quot;</span>,<span class="hljs-string">&quot;uid&quot;</span>:<span class="hljs-string">&quot;c221ac20-cbfa-406b-812a-c44b9d82d6dc&quot;</span>&#125;,<span class="hljs-string">&quot;spec&quot;</span>:&#123;<span class="hljs-string">&quot;clusterIP&quot;</span>:<span class="hljs-string">&quot;10.96.0.10&quot;</span>,<span class="hljs-string">&quot;ports&quot;</span>:[&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;dns&quot;</span>,<span class="hljs-string">&quot;port&quot;</span>:53,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;UDP&quot;</span>,<span class="hljs-string">&quot;targetPort&quot;</span>:53&#125;,&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;dns-tcp&quot;</span>,<span class="hljs-string">&quot;port&quot;</span>:53,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;TCP&quot;</span>,<span class="hljs-string">&quot;targetPort&quot;</span>:53&#125;,&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;metrics&quot;</span>,<span class="hljs-string">&quot;port&quot;</span>:9153,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;TCP&quot;</span>,<span class="hljs-string">&quot;targetPort&quot;</span>:9153&#125;],<span class="hljs-string">&quot;selector&quot;</span>:&#123;<span class="hljs-string">&quot;k8s-app&quot;</span>:<span class="hljs-string">&quot;kube-dns&quot;</span>&#125;,<span class="hljs-string">&quot;sessionAffinity&quot;</span>:<span class="hljs-string">&quot;None&quot;</span>,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;ClusterIP&quot;</span>&#125;,<span class="hljs-string">&quot;status&quot;</span>:&#123;<span class="hljs-string">&quot;loadBalancer&quot;</span>:&#123;&#125;&#125;&#125;],<span class="hljs-string">&quot;kind&quot;</span>:<span class="hljs-string">&quot;ServiceList&quot;</span>,<span class="hljs-string">&quot;metadata&quot;</span>:&#123;<span class="hljs-string">&quot;resourceVersion&quot;</span>:<span class="hljs-string">&quot;377360&quot;</span>,<span class="hljs-string">&quot;selfLink&quot;</span>:<span class="hljs-string">"/api/v1/services"</span>&#125;&#125;<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
如果返回值是空列表，或者响应时长很久（接近 10s）才拿到返回值，说明你的配置可能有误，请仔细检查。<br><strong>完成上述步骤之后，KubeEdge 的边缘 Kube-API 端点功能就已经开启了，接着继续部署EdgeMesh即可。</strong></li>
</ul>
<h2 id="开始部署EdgeMesh"><a href="#开始部署EdgeMesh" class="headerlink" title="开始部署EdgeMesh"></a>开始部署EdgeMesh</h2><p>按照文档中先决条件清除一下污点，添加过滤标签。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash">$ kubectl taint nodes --all node-role.kubernetes.io/master-<br>$ kubectl label services kubernetes service.edgemesh.kubeedge.io/service-proxy-name=<span class="hljs-string"><code class="language-hljs bash">$ kubectl taint nodes --all node-role.kubernetes.io/master-<br>$ kubectl label services kubernetes service.edgemesh.kubeedge.io/service-proxy-name=<span class="hljs-string">""</span><br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>然后手动安装EdgeMesh：</p>
<ul>
<li>从Github上clone下EdgeMesh<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash">$ git <span class="hljs-built_in">clone</span> https://github.com/kubeedge/edgemesh.git<br>$ <span class="hljs-built_in"><code class="language-hljs bash">$ git <span class="hljs-built_in">clone</span> https://github.com/kubeedge/edgemesh.git<br>$ <span class="hljs-built_in">cd</span> edgemesh<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure></li>
<li>创建CRD<figure class="highlight plaintext"><table><tr><td class="code"><pre class="line-numbers language-hljs plaintext"><code class="language-hljs plaintext">$ kubectl apply -f build/crds/istio/<br>customresourcedefinition.apiextensions.k8s.io/destinationrules.networking.istio.io created<br>customresourcedefinition.apiextensions.k8s.io/gateways.networking.istio.io created<br>customresourcedefinition.apiextensions.k8s.io/virtualservices.networking.istio.io created<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure></li>
<li>部署edgemesh-agent<br>在下面有一个提示，需要修改<code>build/agent/resources/04-configmap.yaml</code>文件中relayNodes部分，并重新生成PSK密码。<br>relaynode一般就配一个云上的节点作为中继，用master，ip就是master节点ip。PSK根据注释中的网址生成一下就可以，不过自己做实验的话其实不生成也行（bushi<figure class="highlight yaml"><table><tr><td class="code"><pre class="line-numbers language-hljs yaml"><span class="hljs-attr">relayNodes:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">nodeName:</span> <span class="hljs-string">cloud</span> <span class="hljs-comment">#master的名字</span><br>  <span class="hljs-attr">advertiseAddress:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">*.*.*.*</span>  <span class="hljs-comment"><code class="language-hljs yaml"><span class="hljs-attr">relayNodes:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">nodeName:</span> <span class="hljs-string">cloud</span> <span class="hljs-comment">#master的名字</span><br>  <span class="hljs-attr">advertiseAddress:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">*.*.*.*</span>  <span class="hljs-comment">#master的ip</span><br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
后面的注释掉就好了。<br>然后部署edgemesh-agent<figure class="highlight plaintext"><table><tr><td class="code"><pre class="line-numbers language-hljs plaintext"><code class="language-hljs plaintext">$ kubectl apply -f build/agent/resources/<br>serviceaccount/edgemesh-agent created<br>clusterrole.rbac.authorization.k8s.io/edgemesh-agent created<br>clusterrolebinding.rbac.authorization.k8s.io/edgemesh-agent created<br>configmap/edgemesh-agent-cfg created<br>configmap/edgemesh-agent-psk created<br>daemonset.apps/edgemesh-agent created<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure></li>
<li>检查一下<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><code class="language-hljs bash">$ kubectl get all -n kubeedge -o wide<br>NAME                       READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES<br>pod/edgemesh-agent-7gf7g   1/1     Running   0          39s   192.168.0.71    k8s-node1    <none>           <none><br>pod/edgemesh-agent-fwf86   1/1     Running   0          39s   192.168.0.229   k8s-master   <none>           <none><br>pod/edgemesh-agent-twm6m   1/1     Running   0          39s   192.168.5.121   ke-edge2     <none>           <none><br>pod/edgemesh-agent-xwxlp   1/1     Running   0          39s   192.168.5.187   ke-edge1     <none>           <none><br><br>NAME                            DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE   CONTAINERS       IMAGES                           SELECTOR<br>daemonset.apps/edgemesh-agent   4         4         4       4            4           <none>          39s   edgemesh-agent   kubeedge/edgemesh-agent:latest   k8s-app=kubeedge,kubeedge=edgemesh-agent<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
这是官网的检查方法，但感觉没太大用处，就算是<code>running</code>也有可能不能正常工作的。<br>可以在边端<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><code class="language-hljs bash">crictl logs edgemesh的containerID<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
检查一下，看看日志是不是正常的，或者卡在了哪个地方，如果是正常的会有<code>heartbeat</code>定期发送。</li>
</ul>
<h1 id="运行EdgeMesh测试案例"><a href="#运行EdgeMesh测试案例" class="headerlink" title="运行EdgeMesh测试案例"></a>运行EdgeMesh测试案例</h1><p>墙裂推荐跑一下，能发现很多问题。向前辈求助，前辈也都会先问测试案例有没有跑通。我跑了带星号的那个<a target="_blank" rel="noopener" href="https://edgemesh.netlify.app/zh/guide/test-case.html#%E8%B7%A8%E8%BE%B9%E4%BA%91%E9%80%9A%E4%BF%A1">跨边云通信测试（Cross-Edge-Cloud）</a>。</p>
<ul>
<li><p>1.部署测试pod。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><code class="language-hljs bash">$ kubectl apply -f examples/test-pod.yaml<br>pod/alpine-test created<br>pod/websocket-test created<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure></li>
<li><p>2.部署边云通信测试需要的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><code class="language-hljs bash">$ kubectl apply -f examples/cloudzone.yaml<br>namespace/cloudzone created<br>deployment.apps/tcp-echo-cloud created<br>service/tcp-echo-cloud-svc created<br>deployment.apps/busybox-sleep-cloud created<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><code class="language-hljs bash">$ kubectl apply -f examples/edgezone.yaml<br>namespace/edgezone created<br>deployment.apps/tcp-echo-edge created<br>service/tcp-echo-edge-svc created<br>deployment.apps/busybox-sleep-edge created<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>当时实验进行到这一步的时候我遇到了第一个问题，应该被部署到边端，namespace为edgezone的pod一直处于<code>ContainerCreating</code>状态，因为Pod没办法被部署上，自然没办法查看日志（<code>crictl logs containerID</code>），又没办法从云端查看（<code>kubectl logs</code>），<code>kubectl describe pod</code>信息量又为0，所以我就<code>systemctl status edgecore</code>，终于看到了相关报错信息（虽然好像有更好的方法？），原因是边端<code>/run/flannel/subnet.env</code>文件不存在，我看了一下云端有，于是就在边端创造了一份和云端内容相同的文件，过了一小会pod都显示为<code>running</code>状态。</p>
</li>
<li><p>3.云访问边</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre class="line-numbers language-hljs plaintext"><code class="language-hljs plaintext">$ BUSYBOX_POD=$(kubectl get all -n cloudzone | grep pod/busybox | awk &#x27;&#123;print $1&#125;&#x27;)<br>$ kubectl -n cloudzone exec $BUSYBOX_POD -c busybox -i -t -- sh<br>$ telnet tcp-echo-edge-svc.edgezone 2701<br>Welcome, you are connected to node ke-edge1.<br>Running on Pod tcp-echo-edge.<br>In namespace edgezone.<br>With IP address 172.17.0.2.<br>Service default.<br>Hello Edge, I am Cloud.<br>Hello Edge, I am Cloud.<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>我是没有遇到问题的。</p>
</li>
<li><p>4.边访问云<br>官网用的是docker，所以用了<code>docker ps</code>，用crictl就直接</p>
<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash">crictl ps<br><span class="hljs-comment"># 找到busybox的containerID，然后</span><br>crictl <span class="hljs-built_in"><code class="language-hljs bash">crictl ps<br><span class="hljs-comment"># 找到busybox的containerID，然后</span><br>crictl <span class="hljs-built_in">exec</span> -it containerID sh<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>然后我运行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre class="line-numbers language-hljs plaintext"><code class="language-hljs plaintext">$ telnet tcp-echo-cloud-svc.cloudzone 2701<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>出现了问题，大概是<code>name or server unknow</code>，这个其实是因为我不小心把边缘Kube-API给配置错了导致的。<br>然后我配置正确之后，再进行这一步，又出现了问题，显示<code>no route to host</code>，和<a target="_blank" rel="noopener" href="https://github.com/kubeedge/edgemesh/issues/533">这个issue</a>问题一样,然后我按照issue里说的<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/585749690">全网最全EdgeMesh Q&amp;A手册</a>问题三，清理iptables规则，然后重新部署edgemesh，发现就可以跑通了！太激动了当时。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre class="line-numbers language-hljs plaintext"><code class="language-hljs plaintext">$ telnet tcp-echo-cloud-svc.cloudzone 2701<br>Welcome, you are connected to node k8s-master.<br>Running on Pod tcp-echo-cloud.<br>In namespace cloudzone.<br>With IP address 10.244.0.8.<br>Service default.<br>Hello Cloud, I am Edge.<br>Hello Cloud, I am Edge.<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>到这里EdgeMesh就算真正部署成功了。不知道因为EdgeMesh我花费了多少时间。不过其实都是学习必须要经历。自己一开始没有看日志的意识，自己瞎尝试解决问题，现在慢慢出问题第一反应找日志，然后就可以快速解决问题。</p>
</li>
</ul>
<h1 id="部署Sedna"><a href="#部署Sedna" class="headerlink" title="部署Sedna"></a>部署Sedna</h1><p>官方文档：<a target="_blank" rel="noopener" href="https://sedna.readthedocs.io/en/latest/setup/install.html">https://sedna.readthedocs.io/en/latest/setup/install.html</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><code class="language-hljs bash">curl https://raw.githubusercontent.com/kubeedge/sedna/main/scripts/installation/install.sh | SEDNA_ACTION=create bash -<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>有一个问题是，这个脚本有时候识别不出来版本号，所以要留意一下它输出的信息，如果没有识别出版本号，中断安装过程，卸载Sedna，然后再试一下。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre class="line-numbers language-hljs bash"><span class="hljs-comment"><code class="language-hljs bash"><span class="hljs-comment"># 卸载的命令</span><br>curl https://raw.githubusercontent.com/kubeedge/sedna/main/scripts/installation/install.sh | SEDNA_ACTION=create bash -<br><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></td></tr></table></figure>
<p>然后正常的话就正常运行啦，不正常的话有可能还是需要换成国内镜像。</p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li>k8s+kubeedge+sedna安装全套流程+避坑指南+解决办法：<a target="_blank" rel="noopener" href="https://blog.csdn.net/MacWx/article/details/130200209">https://blog.csdn.net/MacWx/article/details/130200209</a></li>
</ul>
</p></div><div class="share"><span>Share</span>&nbsp;<span class="soc"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></span><span class="soc"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></span><span class="soc"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=https://shemol.tech/2024/06/10/部署KubeEdge、Edgemesh、Sedna/%20Shemol's Blog%20部署KubeEdge、Edgemesh、Sedna"></a></span></div><div class="pagination"><p class="clearfix"><span class="pre pagbuttons"><a role="navigation" href="/2024/06/10/KubeEdge-Sedna%E8%BF%90%E8%A1%8C%E8%81%94%E5%90%88%E6%8E%A8%E7%90%86%E5%AE%9E%E4%BE%8B/" title="KubeEdge-Sedna运行联合推理实例"><i class="fa fa-angle-double-left"></i>&nbsp;Previous post: KubeEdge-Sedna运行联合推理实例</a></span><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2024/06/10/k8s%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%E4%BB%A5%E5%8F%8Akubeedge%E9%83%A8%E7%BD%B2%E5%89%8D%E5%87%86%E5%A4%87/" title="k8s集群安装以及kubeedge部署前准备">Next post: k8s集群安装以及kubeedge部署前准备&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2024&nbsp;<a target="_blank" href="https://shemol.tech" rel="noopener noreferrer">Shemol</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>